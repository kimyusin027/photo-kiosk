<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬í† ì´ì¦˜ 4ì»· í‚¤ì˜¤ìŠ¤í¬</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #111;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      padding: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    .panel {
      background: #1b1b1f;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
    }
    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: #aaa;
    }

    /* ì™¼ìª½: ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° + ì»¨íŠ¸ë¡¤ */
    .preview-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    video {
      width: 100%;
      max-width: 640px;
      border-radius: 12px;
      border: 2px solid #444;
      background: #000;
    }
    .countdown {
      font-size: 48px;
      font-weight: bold;
      color: #ffcc00;
      text-shadow: 0 0 8px rgba(0,0,0,0.7);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    button:not(:disabled):hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #4b5563;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: #ccc;
      margin-top: 4px;
    }
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .status {
      margin-top: 4px;
      font-size: 12px;
      color: #888;
      text-align: center;
      min-height: 18px;
    }

    /* ì˜¤ë¥¸ìª½: 4ì»· ì¸ë„¤ì¼ + ìµœì¢… ê²°ê³¼ */
    .side {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .thumbs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .thumb-slot {
      background: #111;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .thumb-label {
      font-size: 11px;
      color: #999;
    }
    .thumb-canvas {
      width: 100%;
      border-radius: 8px;
      background: #000;
    }
    .final-preview-wrapper {
      margin-top: 8px;
    }
    .final-preview-label {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 4px;
    }
    .final-preview {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 12px;
      background: #050505;
      border: 1px solid #333;
    }
    .download-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    a.download-link {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      background: #22c55e;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.1s, box-shadow 0.1s, transform 0.1s;
    }
    a.download-link:hover {
      opacity: 1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      transform: translateY(-1px);
    }
    a.download-link[aria-disabled="true"] {
      pointer-events: none;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ì™¼ìª½: ì‹¤ì‹œê°„ í”„ë¦¬ë·° + ì´¬ì˜ ì»¨íŠ¸ë¡¤ -->
    <div class="panel">
      <h1>í¬í† ì´ì¦˜ 4ì»·</h1>
      <p class="subtitle">ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ 3ì´ˆ ê°„ê²© 4ì»· ìë™ ì´¬ì˜ Â· í‘ë°± í•„í„° ì ìš© í›„ PNG ë‹¤ìš´ë¡œë“œ</p>
      <div class="preview-area">
        <video id="video" autoplay playsinline muted></video>
        <div id="countdown" class="countdown"></div>

        <div class="controls">
          <button id="startSequenceBtn">ğŸ¬ 4ì»· ì´¬ì˜ ì‹œì‘</button>
          <button id="resetBtn" class="btn-secondary">ğŸ§¹ ì´ˆê¸°í™”</button>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="grayscaleCheckbox" />
          <label for="grayscaleCheckbox">í‘ë°± í•„í„° ì ìš©</label>
        </div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: 4ì»· ì¸ë„¤ì¼ & ìµœì¢… ê²°ê³¼ -->
    <div class="panel side">
      <div>
        <h1>ì´¬ì˜ ì¤‘ì¸ 4ì»·</h1>
        <p class="subtitle">ê° ì¹¸ì— ìˆœì„œëŒ€ë¡œ ì‚¬ì§„ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
        <div class="thumbs">
          <div class="thumb-slot">
            <div class="thumb-label">1ì»·</div>
            <canvas id="thumb1" class="thumb-canvas"></canvas>
          </div>
          <div class="thumb-slot">
            <div class="thumb-label">2ì»·</div>
            <canvas id="thumb2" class="thumb-canvas"></canvas>
          </div>
          <div class="thumb-slot">
            <div class="thumb-label">3ì»·</div>
            <canvas id="thumb3" class="thumb-canvas"></canvas>
          </div>
          <div class="thumb-slot">
            <div class="thumb-label">4ì»·</div>
            <canvas id="thumb4" class="thumb-canvas"></canvas>
          </div>
        </div>
      </div>

      <div class="final-preview-wrapper">
        <div class="final-preview-label">ìµœì¢… 4ì»· ê²°ê³¼</div>
        <img id="finalImage" class="final-preview" alt="4ì»· ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì´¬ì˜ í›„ í‘œì‹œë¨)" />
        <div class="download-row">
          <a id="downloadLink" class="download-link" href="#" download="photo4cut.png" aria-disabled="true">
            â¬‡ 4ì»· PNG ë‹¤ìš´ë¡œë“œ
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ í•©ì„±ìš© ìº”ë²„ìŠ¤ (í™”ë©´ì—ëŠ” ì•ˆ ë³´ì„) -->
  <canvas id="hiddenCompositeCanvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById("video");
    const countdownEl = document.getElementById("countdown");
    const statusEl = document.getElementById("status");
    const startSequenceBtn = document.getElementById("startSequenceBtn");
    const resetBtn = document.getElementById("resetBtn");
    const grayscaleCheckbox = document.getElementById("grayscaleCheckbox");

    const thumbCanvases = [
      document.getElementById("thumb1"),
      document.getElementById("thumb2"),
      document.getElementById("thumb3"),
      document.getElementById("thumb4"),
    ];

    const finalImageEl = document.getElementById("finalImage");
    const downloadLink = document.getElementById("downloadLink");
    const compositeCanvas = document.getElementById("hiddenCompositeCanvas");

    let mediaStream = null;
    let capturedCount = 0;
    let isShooting = false;

    // --- ìœ í‹¸: ì§€ì—° í•¨ìˆ˜ ---
    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    // --- ì¹´ë©”ë¼ ì‹œì‘ ---
    async function startCamera() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = mediaStream;
        statusEl.textContent = "ì¹´ë©”ë¼ ì—°ê²° ì™„ë£Œ. 4ì»· ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message;
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message);
      }
    }

    // --- ì¹´ë©”ë¼ ì •ì§€ ---
    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach((t) => t.stop());
        mediaStream = null;
      }
    }

    // --- 1ì¥ ì´¬ì˜í•´ì„œ ì§€ì •ëœ ì¸ë„¤ì¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ---
    function captureToThumb(index) {
      const canvas = thumbCanvases[index];
      const ctx = canvas.getContext("2d");
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      capturedCount = Math.max(capturedCount, index + 1);
    }

    // --- 4ì»· í•©ì„± & í‘ë°± í•„í„° ì ìš© ---
    function composeFourCut() {
      if (capturedCount < 4) {
        statusEl.textContent = "4ì¥ì´ ëª¨ë‘ ì´¬ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }

      const first = thumbCanvases[0];
      const srcW = first.width;
      const srcH = first.height;

      if (!srcW || !srcH) {
        statusEl.textContent = "ì´¬ì˜ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // ìµœì¢… 4ì»· ë¹„ìœ¨ ì„¤ì •
      const frameWidth = 800;          // ìµœì¢… í­(px)
      const scale = frameWidth / srcW; // ì›ë³¸ ë¹„ìœ¨ì— ë§ê²Œ ì¶•ì†Œ/í™•ëŒ€
      const photoHeight = srcH * scale;
      const margin = 30;               // í…Œë‘ë¦¬/ê°„ê²©
      const frameHeight = margin + (photoHeight * 4) + (margin * 5);

      compositeCanvas.width = frameWidth;
      compositeCanvas.height = frameHeight;

      const ctx = compositeCanvas.getContext("2d");

      // ë°°ê²½ (í¬í† ì´ì¦˜ ëŠë‚Œ í° ë°”íƒ• + ì‚´ì§ í•‘í¬ë¹›)
      const gradient = ctx.createLinearGradient(0, 0, 0, frameHeight);
      gradient.addColorStop(0, "#ffe4f0");
      gradient.addColorStop(1, "#ffffff");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, frameWidth, frameHeight);

      // 4ì¥ì˜ ì‚¬ì§„ì„ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë°°ì¹˜
      for (let i = 0; i < 4; i++) {
        const y = margin + (photoHeight + margin) * i + margin;
        ctx.save();
        ctx.beginPath();
        const radius = 24;
        const x = margin;
        const w = frameWidth - margin * 2;
        const h = photoHeight;

        // ë‘¥ê·¼ ëª¨ì„œë¦¬ í´ë¦¬í•‘
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + w - radius, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
        ctx.lineTo(x + w, y + h - radius);
        ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
        ctx.lineTo(x + radius, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
        ctx.clip();

        ctx.drawImage(thumbCanvases[i], x, y, w, h);
        ctx.restore();
      }

      // í‘ë°± í•„í„° ì˜µì…˜ ì ìš©
      if (grayscaleCheckbox.checked) {
        const imageData = ctx.getImageData(0, 0, compositeCanvas.width, compositeCanvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const gray = 0.299 * r + 0.587 * g + 0.114 * b;
          data[i] = data[i + 1] = data[i + 2] = gray;
        }
        ctx.putImageData(imageData, 0, 0);
      }

      const dataUrl = compositeCanvas.toDataURL("image/png");
      finalImageEl.src = dataUrl;
      downloadLink.href = dataUrl;
      downloadLink.setAttribute("aria-disabled", "false");

      statusEl.textContent = "4ì»· í•©ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. PNG ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.";
    }

    // --- 3â†’2â†’1 ì¹´ìš´íŠ¸ë‹¤ìš´ + ì´¬ì˜ ì‹œí€€ìŠ¤ ---
    async function runFourCutSequence() {
      if (!mediaStream) {
        statusEl.textContent = "ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      if (isShooting) return;

      isShooting = true;
      capturedCount = 0;
      downloadLink.setAttribute("aria-disabled", "true");
      finalImageEl.src = "";
      statusEl.textContent = "4ì»· ì´¬ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´ ì£¼ì„¸ìš”!";
      startSequenceBtn.disabled = true;

      // 4ì¥ì˜ ì‚¬ì§„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì´¬ì˜
      for (let i = 0; i < 4; i++) {
        // ì¹´ìš´íŠ¸ë‹¤ìš´ 3,2,1
        for (let count = 3; count >= 1; count--) {
          countdownEl.textContent = count;
          await delay(1000);
        }
        countdownEl.textContent = "ğŸ“¸";
        captureToThumb(i);
        statusEl.textContent = `${i + 1}ì»· ì´¬ì˜ ì™„ë£Œ`;
        await delay(400);
        countdownEl.textContent = "";
        await delay(400);
      }

      isShooting = false;
      startSequenceBtn.disabled = false;

      // 4ì»· í•©ì„± ìˆ˜í–‰
      composeFourCut();
    }

    // --- ì´ˆê¸°í™” ---
    function resetAll() {
      capturedCount = 0;
      isShooting = false;
      countdownEl.textContent = "";
      statusEl.textContent = "ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ 4ì»· ì´¬ì˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      thumbCanvases.forEach((c) => {
        const ctx = c.getContext("2d");
        ctx.clearRect(0, 0, c.width, c.height);
      });
      finalImageEl.src = "";
      downloadLink.href = "#";
      downloadLink.setAttribute("aria-disabled", "true");
    }

    // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    startSequenceBtn.addEventListener("click", runFourCutSequence);
    resetBtn.addEventListener("click", resetAll);

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì‹œì‘ ---
    window.addEventListener("load", () => {
      startCamera();
    });

    // --- í˜ì´ì§€ ë– ë‚  ë•Œ ì¹´ë©”ë¼ ì •ì§€ ---
    window.addEventListener("beforeunload", () => {
      stopCamera();
    });
  </script>
</body>
</html>
