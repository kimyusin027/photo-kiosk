<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬í† ì´ì¦˜ 4ì»· í‚¤ì˜¤ìŠ¤í¬</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #111827;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      width: 100%;
      background: #020617;
      color: #f9fafb;
      padding: 12px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.12em;
    }

    /* íƒ­ */
    .tab-bar {
      width: 100%;
      max-width: 1200px;
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .tab-button {
      flex: 1;
      max-width: 260px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
      font-size: 14px;
      padding: 10px 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.1s, color 0.1s, box-shadow 0.1s, transform 0.1s, border-color 0.1s;
    }
    .tab-button span.step {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 11px;
      color: #e5e7eb;
    }
    .tab-button.active {
      background: #1d4ed8;
      border-color: #2563eb;
      color: #f9fafb;
      box-shadow: 0 4px 12px rgba(37,99,235,0.45);
      transform: translateY(-1px);
    }
    .tab-button.active span.step {
      background: #f9fafb;
      color: #1d4ed8;
      border-color: transparent;
    }

    /* ê³µí†µ ì»¨í…Œì´ë„ˆ */
    .view-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 12px 16px 32px;
      flex: 1;
    }

    .view {
      display: none;
      width: 100%;
      max-width: 1200px;
    }
    .view.active {
      display: block;
    }

    .container {
      width: 100%;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    .panel {
      background: #111827;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      border: 1px solid #1f2937;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 22px;
    }
    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: #9ca3af;
    }

    /* ì´¬ì˜ í˜ì´ì§€ - ì™¼ìª½ */
    .preview-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    video {
      width: 100%;
      max-width: 640px;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      border: 2px solid #374151;
      background: #020617;
    }
    .countdown {
      font-size: 48px;
      font-weight: bold;
      color: #facc15;
      text-shadow: 0 0 8px rgba(0,0,0,0.7);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    button:not(:disabled):hover {
      box-shadow: 0 4px 10px rgba(15,23,42,0.7);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #4b5563;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: #ccc;
      margin-top: 4px;
    }
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .status {
      margin-top: 4px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      min-height: 18px;
    }

    /* ë ˆì´ì•„ì›ƒ ì„ íƒ ì˜ì—­ */
    .layout-picker {
      width: 100%;
      margin-bottom: 10px;
    }
    .layout-title {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 6px;
      text-align: center;
    }
    .layout-options {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .layout-option {
      background: #020617;
      border-radius: 12px;
      padding: 8px 10px;
      border: 2px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 90px;
      transition: border-color 0.1s, box-shadow 0.1s, transform 0.1s, background 0.1s;
    }
    .layout-option.selected {
      border-color: #facc15;
      background: #1f2937;
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      transform: translateY(-1px);
    }
    .layout-label {
      font-size: 11px;
      color: #e5e7eb;
    }
    .layout-preview {
      width: 56px;
      height: 56px;
      background: #020617;
      border-radius: 10px;
      padding: 4px;
      display: grid;
      gap: 3px;
    }
    .layout-preview div {
      background: #f9fafb;
      border-radius: 4px;
    }
    .layout-vertical {
      grid-template-rows: repeat(4, 1fr);
    }
    .layout-horizontal {
      grid-template-columns: repeat(4, 1fr);
    }
    .layout-square {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    /* ì´¬ì˜ í˜ì´ì§€ - ì˜¤ë¥¸ìª½(ì¸ë„¤ì¼) */
    .side {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .thumbs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .thumb-slot {
      background: #020617;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .thumb-label {
      font-size: 11px;
      color: #9ca3af;
    }
    .thumb-canvas {
      width: 100%;
      border-radius: 8px;
      background: #0b1120;
      aspect-ratio: 3 / 4;
    }

    /* ê²°ê³¼ í˜ì´ì§€ */
    .view-result .container {
      grid-template-columns: 1fr;
    }
    .result-main {
      display: flex;
      flex-direction: row;
      gap: 24px;
      align-items: stretch;
    }
    .result-left {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .result-right {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .final-preview-label {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .final-preview {
      width: 100%;
      max-height: 520px;
      object-fit: contain;
      border-radius: 16px;
      background: #020617;
      border: 1px solid #1f2937;
    }
    .download-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    a.download-link {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      background: #22c55e;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      opacity: 0.9;
      transition: opacity 0.1s, box-shadow 0.1s, transform 0.1s;
    }
    a.download-link:hover {
      opacity: 1;
      box-shadow: 0 4px 10px rgba(21,128,61,0.7);
      transform: translateY(-1px);
    }
    a.download-link[aria-disabled="true"] {
      pointer-events: none;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    /* QR ì½”ë“œ */
    .qr-wrapper {
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed #374151;
      background: #020617;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      height: 100%;
    }
    .qr-label {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
    }
    #qrcode {
      width: 160px;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      .result-main {
        flex-direction: column;
      }
    }
  </style>

  <!-- QR ì½”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">í¬í† ì´ì¦˜</div>

  <!-- íƒ­ -->
  <div class="tab-bar">
    <button class="tab-button active" data-view="capture">
      <span class="step">1</span> ì´¬ì˜í•˜ê¸°
    </button>
    <button class="tab-button" data-view="result">
      <span class="step">2</span> ê²°ê³¼ í™•ì¸ / ë‹¤ìš´ë¡œë“œ
    </button>
  </div>

  <div class="view-wrap">
    <!-- ====== VIEW 1 : ì´¬ì˜ í˜ì´ì§€ ====== -->
    <div class="view view-capture active">
      <div class="container">
        <!-- ì™¼ìª½: ì¹´ë©”ë¼ + ë ˆì´ì•„ì›ƒ + ì»¨íŠ¸ë¡¤ -->
        <div class="panel">
          <h1>í¬í† ì´ì¦˜ 4ì»·</h1>
          <p class="subtitle">
            ë ˆì´ì•„ì›ƒì„ ì„ íƒí•˜ê³  3ì´ˆ ê°„ê²©ìœ¼ë¡œ 4ì»· ìë™ ì´¬ì˜ Â· í‘ë°± í•„í„° ì ìš© ê°€ëŠ¥
          </p>

          <!-- ë ˆì´ì•„ì›ƒ ì„ íƒ -->
          <div class="layout-picker">
            <div class="layout-title">ë ˆì´ì•„ì›ƒ ì„ íƒ</div>
            <div class="layout-options">
              <div class="layout-option selected" data-layout="vertical">
                <div class="layout-preview layout-vertical">
                  <div></div><div></div><div></div><div></div>
                </div>
                <div class="layout-label">ì„¸ë¡œ 4ì»·</div>
              </div>
              <div class="layout-option" data-layout="horizontal">
                <div class="layout-preview layout-horizontal">
                  <div></div><div></div><div></div><div></div>
                </div>
                <div class="layout-label">ê°€ë¡œ 4ì»·</div>
              </div>
              <div class="layout-option" data-layout="square">
                <div class="layout-preview layout-square">
                  <div></div><div></div><div></div><div></div>
                </div>
                <div class="layout-label">ì •ì‚¬ê°í˜• 2Ã—2</div>
              </div>
            </div>
          </div>

          <div class="preview-area">
            <video id="video" autoplay playsinline muted></video>
            <div id="countdown" class="countdown"></div>

            <div class="controls">
              <button id="startSequenceBtn">ğŸ¬ 4ì»· ì´¬ì˜ ì‹œì‘</button>
              <button id="resetBtn" class="btn-secondary">ğŸ§¹ ì´ˆê¸°í™”</button>
            </div>
            <div class="checkbox-row">
              <input type="checkbox" id="grayscaleCheckbox" />
              <label for="grayscaleCheckbox">í‘ë°± í•„í„° ì ìš©</label>
            </div>
            <div id="status" class="status"></div>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì´¬ì˜ ì¤‘ì¸ 4ì»· ì¸ë„¤ì¼ -->
        <div class="panel side">
          <h1>ì´¬ì˜ ì¤‘ì¸ 4ì»·</h1>
          <p class="subtitle">ê° ì¹¸ì— ìˆœì„œëŒ€ë¡œ ì‚¬ì§„ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
          <div class="thumbs">
            <div class="thumb-slot">
              <div class="thumb-label">1ì»·</div>
              <canvas id="thumb1" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">2ì»·</div>
              <canvas id="thumb2" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">3ì»·</div>
              <canvas id="thumb3" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">4ì»·</div>
              <canvas id="thumb4" class="thumb-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== VIEW 2 : ê²°ê³¼ / ë‹¤ìš´ë¡œë“œ í˜ì´ì§€ ====== -->
    <div class="view view-result">
      <div class="container">
        <div class="panel">
          <div class="result-main">
            <div class="result-left">
              <h1>ìµœì¢… 4ì»· ê²°ê³¼</h1>
              <p class="subtitle">ë™ì–‘ë¯¸ë˜ëŒ€í•™êµ ë§ˆìŠ¤ì½”íŠ¸ê°€ í•˜ë‹¨ì— í•©ì„±ë©ë‹ˆë‹¤.</p>
              <div class="final-preview-label">ë¯¸ë¦¬ë³´ê¸°</div>
              <img id="finalImage" class="final-preview" alt="4ì»· ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì´¬ì˜ í›„ í‘œì‹œë¨)" />
              <div class="download-row">
                <a id="downloadLink" class="download-link" href="#" download="photo4cut.png" aria-disabled="true">
                  â¬‡ 4ì»· PNG ë‹¤ìš´ë¡œë“œ
                </a>
                <button type="button" class="btn-secondary" id="backToShootBtn">
                  â¬… ë‹¤ì‹œ ì´¬ì˜ í™”ë©´ìœ¼ë¡œ
                </button>
              </div>
            </div>
            <div class="result-right">
              <div class="qr-wrapper">
                <div class="qr-label">
                  QR ì½”ë“œë¥¼ íœ´ëŒ€í°ìœ¼ë¡œ ìŠ¤ìº”í•˜ë©´<br />
                  ì´ í¬í† ì´ì¦˜ í˜ì´ì§€ê°€ ì—´ë¦½ë‹ˆë‹¤.<br />
                  íœ´ëŒ€í°ì—ì„œ ë‹¤ì‹œ ì´¬ì˜í•˜ê³  ì´ë¯¸ì§€ë¥¼ ì €ì¥í•´ ë³´ì„¸ìš”.
                </div>
                <div id="qrcode">
                  <!-- ì´¬ì˜ í›„ ìë™ ìƒì„± -->
                </div>
              </div>
            </div>
          </div>
          <div class="status" id="resultStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ í•©ì„±ìš© ìº”ë²„ìŠ¤ (í™”ë©´ì—ëŠ” ì•ˆ ë³´ì„) -->
  <canvas id="hiddenCompositeCanvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById("video");
    const countdownEl = document.getElementById("countdown");
    const statusEl = document.getElementById("status");
    const resultStatusEl = document.getElementById("resultStatus");
    const startSequenceBtn = document.getElementById("startSequenceBtn");
    const resetBtn = document.getElementById("resetBtn");
    const backToShootBtn = document.getElementById("backToShootBtn");
    const grayscaleCheckbox = document.getElementById("grayscaleCheckbox");

    const thumbCanvases = [
      document.getElementById("thumb1"),
      document.getElementById("thumb2"),
      document.getElementById("thumb3"),
      document.getElementById("thumb4"),
    ];

    const finalImageEl = document.getElementById("finalImage");
    const downloadLink = document.getElementById("downloadLink");
    const compositeCanvas = document.getElementById("hiddenCompositeCanvas");

    const layoutOptionElements = document.querySelectorAll(".layout-option");
    let currentLayout = "vertical"; // vertical | horizontal | square

    const qrcodeContainer = document.getElementById("qrcode");
    let qrInstance = null;

    // ë§ˆìŠ¤ì½”íŠ¸ ì´ë¯¸ì§€ (index.htmlê³¼ ê°™ì€ ê²½ë¡œì— mascot.png í•„ìš”)
    const mascotImg = new Image();
    mascotImg.src = "mascot.png";

    let mediaStream = null;
    let capturedCount = 0;
    let isShooting = false;

    // íƒ­ / ë·°
    const tabButtons = document.querySelectorAll(".tab-button");
    const viewCapture = document.querySelector(".view-capture");
    const viewResult = document.querySelector(".view-result");

    function switchView(viewName) {
      if (viewName === "capture") {
        viewCapture.classList.add("active");
        viewResult.classList.remove("active");
      } else {
        viewResult.classList.add("active");
        viewCapture.classList.remove("active");
      }
      tabButtons.forEach(btn => {
        if (btn.dataset.view === viewName) btn.classList.add("active");
        else btn.classList.remove("active");
      });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        switchView(btn.dataset.view);
      });
    });
    backToShootBtn.addEventListener("click", () => switchView("capture"));

    // ìœ í‹¸: ì§€ì—°
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ì¹´ë©”ë¼ ì‹œì‘
    async function startCamera() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = mediaStream;
        statusEl.textContent = "ì¹´ë©”ë¼ ì—°ê²° ì™„ë£Œ. ë ˆì´ì•„ì›ƒ ì„ íƒ í›„ 4ì»· ì´¬ì˜ì„ ì‹œì‘í•˜ì„¸ìš”.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message;
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message);
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
    }

    // 1ì¥ ìº¡ì²˜
    function captureToThumb(index) {
      const canvas = thumbCanvases[index];
      const ctx = canvas.getContext("2d");
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      capturedCount = Math.max(capturedCount, index + 1);
    }

    // QR ì½”ë“œ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ URL ê¸°ì¤€)
    function updateQRCode() {
      qrcodeContainer.innerHTML = "";
      const pageUrl = window.location.href.split("#")[0];

      qrInstance = new QRCode(qrcodeContainer, {
        text: pageUrl,
        width: 160,
        height: 160,
      });
    }

    // 4ì»· í•©ì„± + ë§ˆìŠ¤ì½”íŠ¸ + í‘ë°±
    function composeFourCut() {
      if (capturedCount < 4) {
        statusEl.textContent = "4ì¥ì´ ëª¨ë‘ ì´¬ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }

      const first = thumbCanvases[0];
      const srcW = first.width;
      const srcH = first.height;
      if (!srcW || !srcH) {
        statusEl.textContent = "ì´¬ì˜ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const layout = currentLayout;
      const outer = 40;
      const inner = 20;

      let frameWidth, frameHeight, photoW, photoH, rows, cols;
      if (layout === "horizontal") {
        cols = 4; rows = 1;
        frameWidth = 1200;
        const availW = frameWidth - outer * 2 - inner * (cols - 1);
        photoW = availW / cols;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + photoH;
      } else if (layout === "square") {
        cols = 2; rows = 2;
        frameWidth = 800;
        const availW = frameWidth - outer * 2 - inner * (cols - 1);
        photoW = availW / cols;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + rows * photoH + inner * (rows - 1);
      } else {
        cols = 1; rows = 4;
        frameWidth = 800;
        const availW = frameWidth - outer * 2;
        photoW = availW;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + rows * photoH + inner * (rows - 1);
      }

      const mascotSpace = 120;
      frameHeight += mascotSpace;

      compositeCanvas.width = frameWidth;
      compositeCanvas.height = frameHeight;

      const ctx = compositeCanvas.getContext("2d");

      const gradient = ctx.createLinearGradient(0, 0, 0, frameHeight);
      gradient.addColorStop(0, "#ffe4f0");
      gradient.addColorStop(1, "#ffffff");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, frameWidth, frameHeight);

      // ì‚¬ì§„ ê·¸ë¦¬ê¸°
      for (let i = 0; i < 4; i++) {
        let row, col;
        if (layout === "horizontal") {
          row = 0; col = i;
        } else if (layout === "square") {
          row = Math.floor(i / 2);
          col = i % 2;
        } else {
          row = i; col = 0;
        }

        const x = outer + col * (photoW + inner);
        const y = outer + row * (photoH + inner);

        ctx.save();
        ctx.beginPath();
        const radius = 24;
        const w = photoW;
        const h = photoH;

        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + w - radius, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
        ctx.lineTo(x + w, y + h - radius);
        ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
        ctx.lineTo(x + radius, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
        ctx.clip();

        ctx.drawImage(thumbCanvases[i], x, y, w, h);
        ctx.restore();
      }

      // ë§ˆìŠ¤ì½”íŠ¸
      if (mascotImg.complete && mascotImg.naturalWidth > 0) {
        const targetWidth = frameWidth * 0.25;
        const scale = targetWidth / mascotImg.naturalWidth;
        const mW = mascotImg.naturalWidth * scale;
        const mH = mascotImg.naturalHeight * scale;
        const mx = (frameWidth - mW) / 2;
        const my = frameHeight - mH - outer * 0.5;

        ctx.drawImage(mascotImg, mx, my, mW, mH);
      }

      // í‘ë°± í•„í„°
      if (grayscaleCheckbox.checked) {
        const imageData = ctx.getImageData(0, 0, compositeCanvas.width, compositeCanvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i], g = data[i+1], b = data[i+2];
          const gray = 0.299*r + 0.587*g + 0.114*b;
          data[i] = data[i+1] = data[i+2] = gray;
        }
        ctx.putImageData(imageData, 0, 0);
      }

      const dataUrl = compositeCanvas.toDataURL("image/png");
      finalImageEl.src = dataUrl;
      downloadLink.href = dataUrl;
      downloadLink.setAttribute("aria-disabled", "false");

      statusEl.textContent = "4ì»· í•©ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      resultStatusEl.textContent =
        (layout === "vertical" ? "ì„¸ë¡œ 4ì»·" : layout === "horizontal" ? "ê°€ë¡œ 4ì»·" : "ì •ì‚¬ê°í˜• 2Ã—2") +
        " ë ˆì´ì•„ì›ƒìœ¼ë¡œ í•©ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.";

      // QR ì½”ë“œ ì—…ë°ì´íŠ¸ (í˜ì´ì§€ URL)
      updateQRCode();

      // ìë™ìœ¼ë¡œ ê²°ê³¼ íƒ­ìœ¼ë¡œ ì „í™˜
      switchView("result");
    }

    // ì´¬ì˜ ì‹œí€€ìŠ¤
    async function runFourCutSequence() {
      if (!mediaStream) {
        statusEl.textContent = "ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      if (isShooting) return;

      isShooting = true;
      capturedCount = 0;
      downloadLink.setAttribute("aria-disabled", "true");
      finalImageEl.src = "";
      qrcodeContainer.innerHTML = "";
      statusEl.textContent = "4ì»· ì´¬ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´ ì£¼ì„¸ìš”!";
      resultStatusEl.textContent = "";
      startSequenceBtn.disabled = true;

      for (let i = 0; i < 4; i++) {
        for (let count = 3; count >= 1; count--) {
          countdownEl.textContent = count;
          await delay(1000);
        }
        countdownEl.textContent = "ğŸ“¸";
        captureToThumb(i);
        statusEl.textContent = `${i + 1}ì»· ì´¬ì˜ ì™„ë£Œ`;
        await delay(400);
        countdownEl.textContent = "";
        await delay(400);
      }

      isShooting = false;
      startSequenceBtn.disabled = false;

      composeFourCut();
    }

    // ì´ˆê¸°í™”
    function resetAll() {
      capturedCount = 0;
      isShooting = false;
      countdownEl.textContent = "";
      statusEl.textContent = "ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë ˆì´ì•„ì›ƒì„ ì„ íƒí•˜ê³  ë‹¤ì‹œ 4ì»· ì´¬ì˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      resultStatusEl.textContent = "";
      thumbCanvases.forEach(c => {
        const ctx = c.getContext("2d");
        ctx.clearRect(0, 0, c.width, c.height);
      });
      finalImageEl.src = "";
      downloadLink.href = "#";
      downloadLink.setAttribute("aria-disabled", "true");
      qrcodeContainer.innerHTML = "";
      switchView("capture");
    }

    // ë ˆì´ì•„ì›ƒ ì„ íƒ
    layoutOptionElements.forEach(el => {
      el.addEventListener("click", () => {
        layoutOptionElements.forEach(e => e.classList.remove("selected"));
        el.classList.add("selected");
        currentLayout = el.dataset.layout;
        if (capturedCount >= 4) {
          composeFourCut();
        }
      });
    });

    startSequenceBtn.addEventListener("click", runFourCutSequence);
    resetBtn.addEventListener("click", resetAll);

    window.addEventListener("load", () => {
      startCamera();
    });
    window.addEventListener("beforeunload", () => {
      stopCamera();
    });
  </script>
</body>
</html>
