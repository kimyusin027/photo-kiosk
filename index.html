<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬í† ì´ì¦˜ 4ì»· í‚¤ì˜¤ìŠ¤í¬</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #111;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    /* ìƒë‹¨ ë°” */
    .top-bar {
      width: 100%;
      background: #0f172a;
      color: #f9fafb;
      padding: 12px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.12em;
    }

    .page {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 16px 16px 32px;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    .panel {
      background: #1b1b1f;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }
    h1 {
      margin: 0 0 10px;
      font-size: 24px;
    }
    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: #aaa;
    }

    /* ì™¼ìª½: ë ˆì´ì•„ì›ƒ ì„ íƒ + ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° + ì»¨íŠ¸ë¡¤ */
    .preview-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    video {
      width: 100%;
      max-width: 640px;
      border-radius: 12px;
      border: 2px solid #444;
      background: #000;
    }
    .countdown {
      font-size: 48px;
      font-weight: bold;
      color: #ffcc00;
      text-shadow: 0 0 8px rgba(0,0,0,0.7);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    button:not(:disabled):hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #4b5563;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: #ccc;
      margin-top: 4px;
    }
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .status {
      margin-top: 4px;
      font-size: 12px;
      color: #888;
      text-align: center;
      min-height: 18px;
    }

    /* ë ˆì´ì•„ì›ƒ ì„ íƒ ì˜ì—­ */
    .layout-picker {
      width: 100%;
      margin-bottom: 10px;
    }
    .layout-title {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 6px;
      text-align: center;
    }
    .layout-options {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .layout-option {
      background: #111827;
      border-radius: 12px;
      padding: 8px 10px;
      border: 2px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 90px;
      transition: border-color 0.1s, box-shadow 0.1s, transform 0.1s, background 0.1s;
    }
    .layout-option.selected {
      border-color: #fbbf24;
      background: #1f2937;
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
      transform: translateY(-1px);
    }
    .layout-label {
      font-size: 11px;
      color: #e5e7eb;
    }
    .layout-preview {
      width: 56px;
      height: 56px;
      background: #020617;
      border-radius: 10px;
      padding: 4px;
      display: grid;
      gap: 3px;
    }
    .layout-preview div {
      background: #f9fafb;
      border-radius: 4px;
    }
    .layout-vertical {
      grid-template-rows: repeat(4, 1fr);
    }
    .layout-horizontal {
      grid-template-columns: repeat(4, 1fr);
    }
    .layout-square {
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    /* ì˜¤ë¥¸ìª½: 4ì»· ì¸ë„¤ì¼ + ìµœì¢… ê²°ê³¼ */
    .side {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .thumbs {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .thumb-slot {
      background: #111;
      border-radius: 12px;
      padding: 6px;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .thumb-label {
      font-size: 11px;
      color: #999;
    }
    .thumb-canvas {
      width: 100%;
      border-radius: 8px;
      background: #000;
    }
    .final-preview-wrapper {
      margin-top: 8px;
    }
    .final-preview-label {
      font-size: 13px;
      color: #ccc;
      margin-bottom: 4px;
    }
    .final-preview {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 12px;
      background: #050505;
      border: 1px solid #333;
    }
    .download-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    a.download-link {
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      background: #22c55e;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.1s, box-shadow 0.1s, transform 0.1s;
    }
    a.download-link:hover {
      opacity: 1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      transform: translateY(-1px);
    }
    a.download-link[aria-disabled="true"] {
      pointer-events: none;
      opacity: 0.4;
      box-shadow: none;
      transform: none;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë°” -->
  <div class="top-bar">
    í¬í† ì´ì¦˜
  </div>

  <div class="page">
    <div class="container">
      <!-- ì™¼ìª½: ë ˆì´ì•„ì›ƒ ì„ íƒ + ì‹¤ì‹œê°„ í”„ë¦¬ë·° + ì´¬ì˜ ì»¨íŠ¸ë¡¤ -->
      <div class="panel">
        <h1>í¬í† ì´ì¦˜ 4ì»·</h1>
        <p class="subtitle">ë ˆì´ì•„ì›ƒì„ ì„ íƒí•˜ê³  3ì´ˆ ê°„ê²©ìœ¼ë¡œ 4ì»· ìë™ ì´¬ì˜ Â· í‘ë°± í•„í„° ì ìš© í›„ PNG ë‹¤ìš´ë¡œë“œ</p>

        <!-- ë ˆì´ì•„ì›ƒ ì„ íƒ -->
        <div class="layout-picker">
          <div class="layout-title">ë ˆì´ì•„ì›ƒ ì„ íƒ</div>
          <div class="layout-options">
            <div class="layout-option selected" data-layout="vertical">
              <div class="layout-preview layout-vertical">
                <div></div><div></div><div></div><div></div>
              </div>
              <div class="layout-label">ì„¸ë¡œ 4ì»·</div>
            </div>
            <div class="layout-option" data-layout="horizontal">
              <div class="layout-preview layout-horizontal">
                <div></div><div></div><div></div><div></div>
              </div>
              <div class="layout-label">ê°€ë¡œ 4ì»·</div>
            </div>
            <div class="layout-option" data-layout="square">
              <div class="layout-preview layout-square">
                <div></div><div></div><div></div><div></div>
              </div>
              <div class="layout-label">ì •ì‚¬ê°í˜• 2Ã—2</div>
            </div>
          </div>
        </div>

        <div class="preview-area">
          <video id="video" autoplay playsinline muted></video>
          <div id="countdown" class="countdown"></div>

          <div class="controls">
            <button id="startSequenceBtn">ğŸ¬ 4ì»· ì´¬ì˜ ì‹œì‘</button>
            <button id="resetBtn" class="btn-secondary">ğŸ§¹ ì´ˆê¸°í™”</button>
          </div>
          <div class="checkbox-row">
            <input type="checkbox" id="grayscaleCheckbox" />
            <label for="grayscaleCheckbox">í‘ë°± í•„í„° ì ìš©</label>
          </div>
          <div id="status" class="status"></div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: 4ì»· ì¸ë„¤ì¼ & ìµœì¢… ê²°ê³¼ -->
      <div class="panel side">
        <div>
          <h1>ì´¬ì˜ ì¤‘ì¸ 4ì»·</h1>
          <p class="subtitle">ê° ì¹¸ì— ìˆœì„œëŒ€ë¡œ ì‚¬ì§„ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
          <div class="thumbs">
            <div class="thumb-slot">
              <div class="thumb-label">1ì»·</div>
              <canvas id="thumb1" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">2ì»·</div>
              <canvas id="thumb2" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">3ì»·</div>
              <canvas id="thumb3" class="thumb-canvas"></canvas>
            </div>
            <div class="thumb-slot">
              <div class="thumb-label">4ì»·</div>
              <canvas id="thumb4" class="thumb-canvas"></canvas>
            </div>
          </div>
        </div>

        <div class="final-preview-wrapper">
          <div class="final-preview-label">ìµœì¢… 4ì»· ê²°ê³¼</div>
          <img id="finalImage" class="final-preview" alt="4ì»· ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì´¬ì˜ í›„ í‘œì‹œë¨)" />
          <div class="download-row">
            <a id="downloadLink" class="download-link" href="#" download="photo4cut.png" aria-disabled="true">
              â¬‡ 4ì»· PNG ë‹¤ìš´ë¡œë“œ
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‹¤ì œ í•©ì„±ìš© ìº”ë²„ìŠ¤ (í™”ë©´ì—ëŠ” ì•ˆ ë³´ì„) -->
  <canvas id="hiddenCompositeCanvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById("video");
    const countdownEl = document.getElementById("countdown");
    const statusEl = document.getElementById("status");
    const startSequenceBtn = document.getElementById("startSequenceBtn");
    const resetBtn = document.getElementById("resetBtn");
    const grayscaleCheckbox = document.getElementById("grayscaleCheckbox");

    const thumbCanvases = [
      document.getElementById("thumb1"),
      document.getElementById("thumb2"),
      document.getElementById("thumb3"),
      document.getElementById("thumb4"),
    ];

    const finalImageEl = document.getElementById("finalImage");
    const downloadLink = document.getElementById("downloadLink");
    const compositeCanvas = document.getElementById("hiddenCompositeCanvas");

    const layoutOptionElements = document.querySelectorAll(".layout-option");
    let currentLayout = "vertical"; // vertical | horizontal | square

    let mediaStream = null;
    let capturedCount = 0;
    let isShooting = false;

    // --- ìœ í‹¸: ì§€ì—° í•¨ìˆ˜ ---
    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    // --- ì¹´ë©”ë¼ ì‹œì‘ ---
    async function startCamera() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = mediaStream;
        statusEl.textContent = "ì¹´ë©”ë¼ ì—°ê²° ì™„ë£Œ. ë ˆì´ì•„ì›ƒ ì„ íƒ í›„ 4ì»· ì´¬ì˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message;
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message);
      }
    }

    // --- ì¹´ë©”ë¼ ì •ì§€ ---
    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach((t) => t.stop());
        mediaStream = null;
      }
    }

    // --- 1ì¥ ì´¬ì˜í•´ì„œ ì§€ì •ëœ ì¸ë„¤ì¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ---
    function captureToThumb(index) {
      const canvas = thumbCanvases[index];
      const ctx = canvas.getContext("2d");
      const w = video.videoWidth || 640;
      const h = video.videoHeight || 480;

      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      capturedCount = Math.max(capturedCount, index + 1);
    }

    // --- 4ì»· í•©ì„± & í‘ë°± í•„í„° ì ìš© ---
    function composeFourCut() {
      if (capturedCount < 4) {
        statusEl.textContent = "4ì¥ì´ ëª¨ë‘ ì´¬ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }

      const first = thumbCanvases[0];
      const srcW = first.width;
      const srcH = first.height;

      if (!srcW || !srcH) {
        statusEl.textContent = "ì´¬ì˜ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const layout = currentLayout;
      const outer = 40; // ë°”ê¹¥ ì—¬ë°±
      const inner = 20; // ì‚¬ì§„ ì‚¬ì´ ì—¬ë°±

      let frameWidth, frameHeight, photoW, photoH, rows, cols;

      if (layout === "horizontal") {
        // ê°€ë¡œ 4ì»·
        cols = 4;
        rows = 1;
        frameWidth = 1200;
        const availW = frameWidth - outer * 2 - inner * (cols - 1);
        photoW = availW / cols;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + photoH;
      } else if (layout === "square") {
        // 2x2 ì •ì‚¬ê°í˜•
        cols = 2;
        rows = 2;
        frameWidth = 800;
        const availW = frameWidth - outer * 2 - inner * (cols - 1);
        photoW = availW / cols;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + rows * photoH + inner * (rows - 1);
      } else {
        // ê¸°ë³¸: ì„¸ë¡œ 4ì»·
        cols = 1;
        rows = 4;
        frameWidth = 800;
        const availW = frameWidth - outer * 2;
        photoW = availW;
        const scale = photoW / srcW;
        photoH = srcH * scale;
        frameHeight = outer * 2 + rows * photoH + inner * (rows - 1);
      }

      compositeCanvas.width = frameWidth;
      compositeCanvas.height = frameHeight;

      const ctx = compositeCanvas.getContext("2d");

      // ë°°ê²½ (í¬í† ì´ì¦˜ ëŠë‚Œ ê·¸ë¼ë””ì–¸íŠ¸)
      const gradient = ctx.createLinearGradient(0, 0, 0, frameHeight);
      gradient.addColorStop(0, "#ffe4f0");
      gradient.addColorStop(1, "#ffffff");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, frameWidth, frameHeight);

      // 4ì¥ì˜ ì‚¬ì§„ì„ ë ˆì´ì•„ì›ƒì— ë§ê²Œ ë°°ì¹˜
      for (let i = 0; i < 4; i++) {
        let row, col;
        if (layout === "horizontal") {
          row = 0;
          col = i;
        } else if (layout === "square") {
          row = Math.floor(i / 2);
          col = i % 2;
        } else {
          // vertical
          row = i;
          col = 0;
        }

        const x = outer + col * (photoW + inner);
        const y = outer + row * (photoH + inner);

        ctx.save();
        ctx.beginPath();
        const radius = 24;
        const w = photoW;
        const h = photoH;

        // ë‘¥ê·¼ ëª¨ì„œë¦¬ í´ë¦¬í•‘
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + w - radius, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
        ctx.lineTo(x + w, y + h - radius);
        ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
        ctx.lineTo(x + radius, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
        ctx.clip();

        ctx.drawImage(thumbCanvases[i], x, y, w, h);
        ctx.restore();
      }

      // í‘ë°± í•„í„° ì˜µì…˜ ì ìš©
      if (grayscaleCheckbox.checked) {
        const imageData = ctx.getImageData(0, 0, compositeCanvas.width, compositeCanvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const gray = 0.299 * r + 0.587 * g + 0.114 * b;
          data[i] = data[i + 1] = data[i + 2] = gray;
        }
        ctx.putImageData(imageData, 0, 0);
      }

      const dataUrl = compositeCanvas.toDataURL("image/png");
      finalImageEl.src = dataUrl;
      downloadLink.href = dataUrl;
      downloadLink.setAttribute("aria-disabled", "false");

      statusEl.textContent = `4ì»· í•©ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${layout === "vertical" ? "ì„¸ë¡œ 4ì»·" : layout === "horizontal" ? "ê°€ë¡œ 4ì»·" : "ì •ì‚¬ê°í˜• 2Ã—2"}) PNG ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”.`;
    }

    // --- 3â†’2â†’1 ì¹´ìš´íŠ¸ë‹¤ìš´ + ì´¬ì˜ ì‹œí€€ìŠ¤ ---
    async function runFourCutSequence() {
      if (!mediaStream) {
        statusEl.textContent = "ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        return;
      }
      if (isShooting) return;

      isShooting = true;
      capturedCount = 0;
      downloadLink.setAttribute("aria-disabled", "true");
      finalImageEl.src = "";
      statusEl.textContent = "4ì»· ì´¬ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´ ì£¼ì„¸ìš”!";
      startSequenceBtn.disabled = true;

      // 4ì¥ì˜ ì‚¬ì§„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì´¬ì˜
      for (let i = 0; i < 4; i++) {
        // ì¹´ìš´íŠ¸ë‹¤ìš´ 3,2,1
        for (let count = 3; count >= 1; count--) {
          countdownEl.textContent = count;
          await delay(1000);
        }
        countdownEl.textContent = "ğŸ“¸";
        captureToThumb(i);
        statusEl.textContent = `${i + 1}ì»· ì´¬ì˜ ì™„ë£Œ`;
        await delay(400);
        countdownEl.textContent = "";
        await delay(400);
      }

      isShooting = false;
      startSequenceBtn.disabled = false;

      // 4ì»· í•©ì„± ìˆ˜í–‰
      composeFourCut();
    }

    // --- ì´ˆê¸°í™” ---
    function resetAll() {
      capturedCount = 0;
      isShooting = false;
      countdownEl.textContent = "";
      statusEl.textContent = "ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë ˆì´ì•„ì›ƒì„ ì„ íƒí•˜ê³  ë‹¤ì‹œ 4ì»· ì´¬ì˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      thumbCanvases.forEach((c) => {
        const ctx = c.getContext("2d");
        ctx.clearRect(0, 0, c.width, c.height);
      });
      finalImageEl.src = "";
      downloadLink.href = "#";
      downloadLink.setAttribute("aria-disabled", "true");
    }

    // --- ë ˆì´ì•„ì›ƒ ì„ íƒ í•¸ë“¤ëŸ¬ ---
    layoutOptionElements.forEach((el) => {
      el.addEventListener("click", () => {
        layoutOptionElements.forEach((e) => e.classList.remove("selected"));
        el.classList.add("selected");
        currentLayout = el.dataset.layout;

        // ì´ë¯¸ 4ì¥ì´ ì´¬ì˜ë˜ì–´ ìˆë‹¤ë©´, ë ˆì´ì•„ì›ƒë§Œ ë°”ê¿”ì„œ ì¬í•©ì„±
        if (capturedCount >= 4) {
          composeFourCut();
        }
      });
    });

    // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    startSequenceBtn.addEventListener("click", runFourCutSequence);
    resetBtn.addEventListener("click", resetAll);

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì‹œì‘ ---
    window.addEventListener("load", () => {
      startCamera();
    });

    // --- í˜ì´ì§€ ë– ë‚  ë•Œ ì¹´ë©”ë¼ ì •ì§€ ---
    window.addEventListener("beforeunload", () => {
      stopCamera();
    });
  </script>
</body>
</html>
